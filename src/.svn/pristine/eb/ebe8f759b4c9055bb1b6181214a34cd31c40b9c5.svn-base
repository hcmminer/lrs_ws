package com.viettel.base.cms.serviceImpl;

import com.viettel.base.cms.common.Constant;
import com.viettel.base.cms.dto.*;
import com.viettel.base.cms.model.*;
import com.viettel.base.cms.repo.BTSStationRepo;
import com.viettel.base.cms.repo.ConstructionRepo;
import com.viettel.base.cms.service.BTSStationService;
import com.viettel.base.cms.service.ConstructionService;
import com.viettel.base.cms.service.LocationService;
import com.viettel.base.cms.service.OptionSetValueService;
import com.viettel.base.cms.utils.DataUtil;
import com.viettel.base.cms.utils.FunctionUtils;
import com.viettel.base.cms.utils.SmsUtils;
import com.viettel.vfw5.base.dto.ExecutionResult;
import com.viettel.vfw5.base.utils.DataUtils;
import com.viettel.vfw5.base.utils.ResourceBundle;
import com.viettel.vfw5.base.utils.StringUtils;
import org.apache.commons.httpclient.HttpClient;
import org.apache.commons.httpclient.methods.PostMethod;
import org.apache.commons.httpclient.methods.RequestEntity;
import org.apache.commons.httpclient.methods.StringRequestEntity;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.xssf.usermodel.XSSFRow;
import org.apache.poi.xssf.usermodel.XSSFSheet;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.hibernate.SQLQuery;
import org.hibernate.Session;
import org.hibernate.Transaction;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.env.Environment;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.ObjectUtils;
import org.springframework.web.multipart.MultipartFile;
import utils.Param;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import javax.persistence.RollbackException;
import java.io.ByteArrayOutputStream;
import java.io.UnsupportedEncodingException;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

import static org.apache.poi.ss.usermodel.CellType.NUMERIC;
import static org.apache.poi.ss.usermodel.CellType.STRING;

@Service
public class BTSStationServiceImpl implements BTSStationService {

    private DateFormat formatterDate = new SimpleDateFormat("dd/MM/yyyy");
    private DateFormat formatterString = new SimpleDateFormat("yyyy-MM-dd");

    private DateFormat formatterStringTime = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.S");
    @Autowired
    @PersistenceContext(unitName = Constant.UNIT_NAME_ENTITIES_CMS)
    private EntityManager cms;

    @Autowired
    BTSStationRepo btsStationRepo;

    @Autowired
    BTSStationService btsStationService;

    @Autowired
    LocationService locationService;

    @Autowired
    OptionSetValueService optionSetValueService;

    @Autowired
    Environment env;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public List<BTSStationDTO> searchBTSStation(BTSStationDTO btsStationDTO, String lang) throws Exception {
        String errorId = "";
        try {
            List<BTSStationDTO> lstResult = new ArrayList<>();
            StringBuilder sql = new StringBuilder();
            sql.append(" SELECT "
                    + "         brp.id,    "
                    + "         brp.site_on_contract siteOnContract, "
                    + "         brp.site_on_nims siteOnNims, "
                    + "         brp.longitude, "
                    + "         brp.latitude, "
                    + "         brp.name, "
                    + "         brp.address_wards address, "
                    + "         brp.dist_id district, "
                    + "         brp.pro_id province, "
                    + "         brp.telephone, "
                    + "         brp.no_of_contract contractNo, "
                    + "         brp.period_of_rent periodOfRent, "
                    + "         date_format(brp.start_date_contract,'%d/%m/%Y') startDateContract, "
                    + "         date_format(brp.end_date_contract,'%d/%m/%Y') endDateContract, "
                    + "         date_format(brp.sign_date_contract,'%d/%m/%Y') signDateContract, "
                    + "         date_format(brp.BTS_aired_date,'%d/%m/%Y') btsAiredDate, "
                    + "         brp.rental_fee rentalFee, "
                    + "         brp.payment_time paymentTime, "
                    + "         brp.file_contract fileContract, "
                    + "         brp.file_CR fileCR, "
                    + "         brp.has_electricity hasElectricity, "
                    + "         brp.approved_status approvedStatus, "
                    + "         brp.status, "
                    + "         brp.amount, "
                    + "         date_format(brp.turn_off_date,'%d/%m/%Y') turnOffDate, "
                    + "         brp.created_user createdUser, "
                    + "         date_format(brp.created_date,'%d/%m/%Y') createdDate, "
                    + "         brp.last_modified_user lastModifiedUser, "
                    + "         date_format(brp.last_modified_date,'%d/%m/%Y') lastModifiedDate, "
                    + "         date_format(brp.start_date_payment,'%d/%m/%Y') startDatePayment, "
                    + "         date_format(brp.end_date_payment,'%d/%m/%Y')  endDatePayment, "
                    + "         brp.notes ,"
                    + "         p.pro_code, "
                    + "         p.pro_name provinceName, "
                    + "         pd.dist_name districtName,"
                    + " (select "
                    + "	osv2.name "
                    + "from "
                    + "	option_set_value osv2, "
                    + "	option_set os "
                    + "where "
                    + "	os.status = 1 "
                    + "	and osv2 .status = 1 "
                    + "	and osv2 .option_set_id = os.option_set_id "
                    + "	and os.option_set_code = :optionSetApproveStatus "
                    + "	and osv2.value = brp.approved_status "
                    + "	and osv2.`language` = :lang) approved_status_name,"
                    + "  (select "
                    + "	osv2.name "
                    + "from "
                    + "	option_set_value osv2, "
                    + "	option_set os "
                    + "where "
                    + "	os.status = 1 "
                    + "	and osv2 .status = 1 "
                    + "	and osv2 .option_set_id = os.option_set_id "
                    + "	and os.option_set_code = :optionSetStationStatus "
                    + "	and osv2.value = brp.status "
                    + "	and osv2.`language` = :lang) station_status_name"
                    + "  FROM   bts_rent_place brp "
                    + " left join province p on  brp.pro_id = p.pro_id "
                    + " left join province_district pd on brp.dist_id = pd.dist_id "
                    + " WHERE   1=1  ");
            if (!StringUtils.isNullOrEmpty(btsStationDTO.getProvince())) {
                sql.append(" AND p.pro_code = :provinceCode ");
            }
            if (!StringUtils.isNullOrEmpty(btsStationDTO.getSiteOnNims())) {
                sql.append(" AND brp.site_on_nims like :siteOnNims ");
            }
            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getName())) {
                sql.append(" AND brp.name like :name ");
            }
            if (!StringUtils.isNullOrEmpty(btsStationDTO.getDistrict())) {
                sql.append(" AND pd.dist_id = :distId  ");
            }
            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getHasContractFile()) && btsStationDTO.getHasContractFile() == 1) {
                sql.append("   AND brp.file_contract IS NOT NULL AND brp.file_contract <> '' ");
            }
            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getHasCRFile()) && btsStationDTO.getHasCRFile() == 1) {
                sql.append("  AND brp.file_CR IS NOT NULL AND brp.file_CR <> ''   ");
            }
            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getApprovedStatus())) {
                sql.append(" AND brp.approved_status = :approvedStatus ");
            }
            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStatus())) {
                sql.append(" AND brp.status = :status ");
            }
            sql.append(" ORDER BY   brp.created_date DESC ");
            Query query = cms.createNativeQuery(sql.toString());
            if (!StringUtils.isStringNullOrEmpty(btsStationDTO)) {
                if (!StringUtils.isNullOrEmpty(btsStationDTO.getProvince())) {
                    query.setParameter("provinceCode", btsStationDTO.getProvince().trim());
                }
                if (!StringUtils.isNullOrEmpty(btsStationDTO.getSiteOnNims())) {
                    query.setParameter("siteOnNims", "%" + btsStationDTO.getSiteOnNims().trim() + "%");
                }
                if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getName())) {
                    query.setParameter("name", "%" + btsStationDTO.getName().trim() + "%");
                }
                if (!StringUtils.isNullOrEmpty(btsStationDTO.getDistrict())) {
                    query.setParameter("distId", DataUtils.getLong(btsStationDTO.getDistrict()));
                }
                if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getApprovedStatus())) {
                    query.setParameter("approvedStatus", DataUtils.getLong(btsStationDTO.getApprovedStatus()));
                }
                if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStatus())) {
                    query.setParameter("status", DataUtils.getLong(btsStationDTO.getStatus()));
                }
                query.setParameter("optionSetApproveStatus", Constant.CMS_OPTION_SET.APPROVED_STATUS);
                query.setParameter("optionSetStationStatus", Constant.CMS_OPTION_SET.STATION_STATUS);
                query.setParameter("lang", lang);
            }

            List<Object[]> lst = query.getResultList();
            if (!lst.isEmpty() && lst != null) {
                for (Object[] obj : lst) {
                    int i = 0;
                    BTSStationDTO btsStationDTO1 = new BTSStationDTO();
                    btsStationDTO1.setId(DataUtils.getLong(obj[0]));
                    btsStationDTO1.setSiteOnContract(DataUtils.getString(obj[1]));
                    btsStationDTO1.setSiteOnNims(DataUtils.getString(obj[2]));
                    btsStationDTO1.setLongitude(DataUtils.getString(obj[3]));
                    btsStationDTO1.setLatitude(DataUtils.getString(obj[4]));
                    btsStationDTO1.setName(DataUtils.getString(obj[5]));
                    btsStationDTO1.setAddress(DataUtils.getString(obj[6]));
                    btsStationDTO1.setDistrict(DataUtils.getString(obj[7]));
                    btsStationDTO1.setProvince(DataUtils.getString(obj[8]));
                    btsStationDTO1.setTelephone(DataUtils.getString(obj[9]));
                    btsStationDTO1.setContractNo(DataUtils.getString(obj[10]));
                    btsStationDTO1.setPeriodOfRent(DataUtils.getLong(obj[11]));
                    btsStationDTO1.setStartDateContract(DataUtils.getString(obj[12]));
                    btsStationDTO1.setEndDateContract(DataUtils.getString(obj[13]));
                    btsStationDTO1.setSignDateContract(DataUtils.getString(obj[14]));
                    btsStationDTO1.setBtsAiredDate(DataUtils.getString(obj[15]));
                    btsStationDTO1.setRentalFee(DataUtils.getLong(obj[16]));
                    btsStationDTO1.setPaymentTime(DataUtils.getString(obj[17]));
//                    if (!StringUtils.isStringNullOrEmpty(DataUtils.getString(obj[18]))) {
//                        String s = Base64.getEncoder().encodeToString(DataUtils.getBytes(obj[18]));
//                        btsStationDTO1.setFileContractBase64(s);
//                    }
                    if (!StringUtils.isStringNullOrEmpty(DataUtils.getBytes(obj[18]))) {
                        byte[] testContract = Base64.getDecoder().decode(DataUtils.getBytes(obj[18]));
                        btsStationDTO1.setFileContract(testContract);
                    } else {
                        btsStationDTO1.setFileContract(null);

                    }
//                    btsStationDTO1.setFileContract(DataUtils.getBytes(obj[18]));
                    if (!StringUtils.isStringNullOrEmpty(DataUtils.getBytes(obj[19]))) {
                        byte[] test = Base64.getDecoder().decode(DataUtils.getBytes(obj[19]));
                        btsStationDTO1.setFileCR(test);
                    } else {
                        btsStationDTO1.setFileCR(null);
                    }
                    btsStationDTO1.setHasElectricity(DataUtils.getLong(obj[20]));
                    btsStationDTO1.setApprovedStatus(DataUtils.getLong(obj[21]));
                    btsStationDTO1.setStatus(DataUtils.getLong(obj[22]));
                    btsStationDTO1.setAmount(DataUtils.getLong(obj[23]));
                    btsStationDTO1.setTurnOffDate(DataUtils.getString(obj[24]));
                    btsStationDTO1.setCreatedUser(DataUtils.getString(obj[25]));
                    btsStationDTO1.setCreatedDate(DataUtils.getString(obj[26]));
                    btsStationDTO1.setLastModifiedUser(DataUtils.getString(obj[27]));
                    btsStationDTO1.setLastModifiedDate(DataUtils.getString(obj[28]));
                    btsStationDTO1.setStartDatePayment(DataUtils.getString(obj[29]));
                    btsStationDTO1.setEndDatePayment(DataUtils.getString(obj[30]));
                    if (!StringUtils.isStringNullOrEmpty(DataUtils.getString(obj[31]))) {
                        btsStationDTO1.setNotes(DataUtils.getString(obj[31]));
                    }
                    btsStationDTO1.setProvinceCode(DataUtils.getString(obj[32]));
                    btsStationDTO1.setProvinceName(DataUtils.getString(obj[33]));
                    btsStationDTO1.setDistrictName(DataUtils.getString(obj[34]));
                    btsStationDTO1.setApprovedStatusName(DataUtils.getString(obj[35]));
                    btsStationDTO1.setStatusName(DataUtils.getString(obj[36]));
                    errorId = String.valueOf(btsStationDTO1.getId());
                    lstResult.add(btsStationDTO1);
                }
            }
            return lstResult;
        } catch (Exception e) {
            e.printStackTrace();
            System.out.println(errorId);
            throw e;
        }
    }

    public String getNameStatus(String param, String optionSet) throws Exception {
        String result = "";
        try {
            List<OptionSetValueDTO> lstResult = new ArrayList<>();
            StringBuilder sql = new StringBuilder();
            sql.append(" SELECT   osv.name "
                    + "  FROM   option_set_value osv "
                    + " WHERE   osv.option_set_id = :option_set_id "
                    + " and osv.value = :value ");
            Query query = cms.createNativeQuery(sql.toString());
            if (!StringUtils.isNullOrEmpty(optionSet)) {
                query.setParameter("option_set_id", optionSet);
            }
            if (!StringUtils.isNullOrEmpty(param)) {
                query.setParameter("value", param);
            }
            List<String> lst = query.getResultList();
            if (!lst.isEmpty() && lst != null) {
                for (String obj : lst) {
                    int i = 0;
                    result = DataUtils.getString(obj);

                }
            }
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
        return result;
    }

    public String getNameProvince(String param) throws Exception {
        String result = "";
        try {
            List<OptionSetValueDTO> lstResult = new ArrayList<>();
            StringBuilder sql = new StringBuilder();
            sql.append(" SELECT   p.pro_name "
                    + "  FROM   province p "
                    + " WHERE   p.pro_id = :proId ");
            Query query = cms.createNativeQuery(sql.toString());
            if (!StringUtils.isNullOrEmpty(param)) {
                query.setParameter("proId", param);
            }
            List<String> lst = query.getResultList();
            if (!lst.isEmpty() && lst != null) {
                for (String obj : lst) {
                    int i = 0;
                    if (!StringUtils.isStringNullOrEmpty(obj)) {
                        result = DataUtils.getString(obj);
                    } else {
                        result = "";
                    }

                }
            }
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
        return result;
    }

    public String getCodeProvince(String param) throws Exception {
        String result = "";
        try {
            List<OptionSetValueDTO> lstResult = new ArrayList<>();
            StringBuilder sql = new StringBuilder();
            sql.append(" SELECT   p.pro_code "
                    + "  FROM   province p "
                    + " WHERE   p.pro_id = :proId ");
            Query query = cms.createNativeQuery(sql.toString());
            if (!StringUtils.isNullOrEmpty(param)) {
                query.setParameter("proId", param);
            }
            List<String> lst = query.getResultList();
            if (!lst.isEmpty() && lst != null) {
                for (String obj : lst) {
                    int i = 0;
                    if (!StringUtils.isStringNullOrEmpty(obj)) {
                        result = DataUtils.getString(obj);
                    } else {
                        result = "";
                    }

                }
            }
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
        return result;
    }

    public String getNameDistrict(String param) throws Exception {
        String result = "";
        try {
            List<OptionSetValueDTO> lstResult = new ArrayList<>();
            StringBuilder sql = new StringBuilder();
            sql.append(" SELECT   pd.dist_name "
                    + "  FROM   province_district pd  "
                    + " WHERE   pd.dist_id = :distId ");
            Query query = cms.createNativeQuery(sql.toString());
            if (!StringUtils.isNullOrEmpty(param)) {
                query.setParameter("distId", param);
            }
            List<String> lst = query.getResultList();
            if (!lst.isEmpty() && lst != null) {
                for (String obj : lst) {
                    int i = 0;
                    result = DataUtils.getString(obj);

                }
            }
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
        return result;
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void createBTSStation(BTSStationDTO btsStationDTO) throws Exception {
        try {
            Long btsStationId = DataUtils.getSequence(cms, "bts_rent_place_seq");
            btsStationDTO.setStatus(0L);
            btsStationDTO.setApprovedStatus(0L);
            btsStationDTO.setId(btsStationId);
            BTSStation btsStation = BTSStation.builder()
                    .id(btsStationDTO.getId())
                    .siteOnContract(btsStationDTO.getSiteOnContract().trim())
                    .siteOnNims(btsStationDTO.getSiteOnNims().trim())
                    .longitude(btsStationDTO.getLongitude().trim())
                    .latitude(btsStationDTO.getLatitude().trim())
                    //                    .name(btsStationDTO.getName())
                    //                    .province(btsStationDTO.getProvince())
                    //                    .district(btsStationDTO.getDistrict())
                    //                    .address(btsStationDTO.getAddress())
                    //                    .telephone(btsStationDTO.getTelephone())
                    .contractNo(btsStationDTO.getContractNo().trim())
                    //                    .preiodOfRent(btsStationDTO.getPeriodOfRent())
                    //                    .startDateContract(btsStationDTO.getStartDateContract())
                    //                    .endDateContract(btsStationDTO.getEndDateContract())
                    //                    .signDateContract(btsStationDTO.getSignDateContract())
                    //                    .btsAiredDate(btsStationDTO.getBtsAiredDate())
                    //                    .rentalFee(btsStationDTO.getRentalFee())
                    //                    .paymentTime(btsStationDTO.getPaymentTime())
                    //                    .fileContract(btsStationDTO.getFileContract())
                    //                    .hasElectricity(btsStationDTO.getHasElectricity())
                    //                    .approvedStatus(btsStationDTO.getApprovedStatus())
                    //                    .status(btsStationDTO.getStatus())
                    //                    .createdDate(LocalDateTime.now().toString())
                    //                    .cxreatedUser(btsStationDTO.getCreatedUser())
                    //                    .lastModifiedDate(btsStationDTO.getLastModifiedDate())
                    //                    .lastModifiedUser(btsStationDTO.getLastModifiedUser())
                    .status(btsStationDTO.getStatus())
                    .approvedStatus(btsStationDTO.getApprovedStatus())
                    .createdDate(LocalDateTime.now().toString().trim())
                    .createdUser(btsStationDTO.getCreatedUser().trim())
                    .build();
            btsStationRepo.save(btsStation);
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public ExecutionResult updateBTSStation(List<BTSStationDTO> btsStationDTOList, String roleCode, String language) throws Exception {
        ExecutionResult executionResult = new ExecutionResult();
        ResourceBundle r = new ResourceBundle(language);
        OptionSetValue templateCNUpdate = optionSetValueService.getListByOptionSetValueName(Constant.SMS_CONFIG.SMS, language, Constant.SMS_CONFIG.TCCN_UPDATE_COMPLETE);
        OptionSetValue templateCNDApproved = optionSetValueService.getListByOptionSetValueName(Constant.SMS_CONFIG.SMS, language, Constant.SMS_CONFIG.CND_APPROVED_BTS);
        String provinceCode = "";
        Long quantity = 0L;
        String listBTS = "<";
        int index = 0;
        List<String> provinceCodeList = new ArrayList<>();
        List<BTSStationDTO> btsStationDTOSendSMS = new ArrayList<>();
        byte[] decodeString = new byte[]{};
        ArrayList<String> arr = new ArrayList<String>();
        for (BTSStationDTO btsStationDTO : btsStationDTOList) {
            provinceCode = btsStationDTO.getProvinceCode();
            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getFileContractBase64())) {
//                byte[] string = Base64.getEncoder().encode(btsStationDTO.getFileContractBase64().trim().getBytes());
                decodeString = Base64.getDecoder().decode(btsStationDTO.getFileContractBase64().trim().getBytes("UTF-8"));
                btsStationDTO.setFileContract(decodeString);
            } else {
                decodeString = new byte[]{};
            }
            BTSStation btsStationUpdate = getBTSStationById(btsStationDTO, roleCode);
            if (!StringUtils.isStringNullOrEmpty(btsStationUpdate)) {
                Transaction tx = null;
                try {
//            BTSStation btsStation = BTSStation.builder()
//                    .id(btsStationDTO.getId())
//                    .siteOnContract(btsStationDTO.getSiteOnContract().trim())
//                    .siteOnNims(btsStationDTO.getSiteOnNims().trim())
//                    .longitude(btsStationDTO.getLongitude().trim())
//                    .latitude(btsStationDTO.getLatitude().trim())
//                    .name(btsStationDTO.getName().trim())
//                    .province(btsStationDTO.getProvince().trim())
//                    .district(btsStationDTO.getDistrict().trim())
//                    .address(btsStationDTO.getAddress().trim())
//                    .telephone(btsStationDTO.getTelephone().trim())
//                    .contractNo(btsStationDTO.getContractNo().trim())
//                    .preiodOfRent(btsStationDTO.getPeriodOfRent())
//                    .startDateContract(btsStationDTO.getStartDateContract().trim())
//                    .endDateContract(btsStationDTO.getEndDateContract().trim())
//                    .signDateContract(btsStationDTO.getSignDateContract().trim())
//                    .btsAiredDate(btsStationDTO.getBtsAiredDate().trim())
//                    .rentalFee(btsStationDTO.getRentalFee())
//                    .paymentTime(btsStationDTO.getPaymentTime().trim())
//                    .fileContract(decodeString)
//                    .hasElectricity(btsStationDTO.getHasElectricity())
//                    .approvedStatus(btsStationDTO.getApprovedStatus())
//                    .status(btsStationDTO.getStatus())
//                    .createdDate(LocalDateTime.now().toString().trim())
//                    .createdUser(btsStationDTO.getCreatedUser().trim())
//                    .lastModifiedDate(btsStationDTO.getLastModifiedDate().trim())
//                    .lastModifiedUser(btsStationDTO.getLastModifiedUser().trim())
//                    .build();
//            btsStationRepo.save(btsStation);
                    StringBuilder sql = new StringBuilder();
                    sql.append("update bts_rent_place brp "
                            + "set ");
//            sql.append("status = :status, ");
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getLongitude())) {
                        sql.append("brp.longitude = :longitude, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getLatitude())) {
                        sql.append("brp.latitude = :latitude, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getName())) {
                        sql.append("brp.name = :name, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getAddress())) {
                        sql.append("brp.address_wards = :address, ");
                    }

                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getProvince())) {
                        sql.append("brp.pro_id = :province, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getDistrict())) {
                        sql.append("brp.dist_id = :district, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getTelephone())) {
                        sql.append("brp.telephone = :telephone, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getContractNo())) {
                        sql.append("brp.no_of_contract = :contractNo, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getPreiodOfRent())) {
                        sql.append("brp.period_of_rent = :periodOfRent, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getStartDatePayment())) {

                        sql.append("brp.start_date_payment = :startDatePayment, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getEndDatePayment())) {
                        sql.append("brp.end_date_payment = :endDatePayment, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getStartDateContract())) {
                        sql.append("brp.start_date_contract = :startDateContract, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getEndDateContract())) {
                        sql.append("brp.end_date_contract = :endDateContract, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getSignDateContract())) {
                        sql.append("brp.sign_date_contract = :signDateContract, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getPaymentTime())) {
                        sql.append("brp.payment_time = :paymentTime, ");
                    }
                    if (btsStationUpdate.getFileContract() != null && btsStationUpdate.getFileContract().length > 0) {
                        sql.append("brp.file_contract = :fileContract, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getHasElectricity())) {
                        sql.append("brp.has_electricity = :hasElectricity, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getRentalFee())) {
                        sql.append("brp.rental_fee = :rentalFee, ");
                    }
                    if (Constant.BTS_ROLES.CMS_BTS_CND_STAFF.equals(roleCode)) {
                        if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getApprovedStatus())) {
                            sql.append("brp.approved_status = :approvedStatus, ");
                        }
                        if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getNotes())) {
                            sql.append("brp.notes = :notes, ");
                        }
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getAmount())) {
                        sql.append("brp.amount = :amount, ");
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getStatus())) {
                        sql.append("brp.status = :status ");
                    }
                    sql.append("where ");
                    sql.append("brp.id = :btsStationId ");
                    Query query = cms.createNativeQuery(sql.toString());
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getLongitude())) {
                        query.setParameter("longitude", btsStationUpdate.getLongitude());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getLatitude())) {
                        query.setParameter("latitude", btsStationUpdate.getLatitude());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getName())) {
                        query.setParameter("name", btsStationUpdate.getName());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getAddress())) {
                        query.setParameter("address", btsStationUpdate.getAddress());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getProvince())) {
                        query.setParameter("province", btsStationUpdate.getProvince());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getDistrict())) {
                        query.setParameter("district", btsStationUpdate.getDistrict());
                    }

                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getTelephone())) {
                        query.setParameter("telephone", btsStationUpdate.getTelephone());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getContractNo())) {
                        query.setParameter("contractNo", btsStationUpdate.getContractNo());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getPreiodOfRent())) {
                        query.setParameter("periodOfRent", btsStationUpdate.getPreiodOfRent());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getStartDatePayment())) {
//                        String s = formatterString.format(formatterDate.parse(btsStationUpdate.getStartDatePayment()));
                        query.setParameter("startDatePayment", btsStationUpdate.getStartDatePayment());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getEndDatePayment())) {
                        query.setParameter("endDatePayment", btsStationUpdate.getEndDatePayment());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getStartDateContract())) {
                        query.setParameter("startDateContract", btsStationUpdate.getStartDateContract());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getEndDateContract())) {
                        query.setParameter("endDateContract", btsStationUpdate.getEndDateContract());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getSignDateContract())) {
                        query.setParameter("signDateContract", btsStationUpdate.getSignDateContract());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getPaymentTime())) {
                        query.setParameter("paymentTime", btsStationUpdate.getPaymentTime());
                    }
                    if (btsStationUpdate.getFileContract() != null && btsStationUpdate.getFileContract().length > 0) {
                        query.setParameter("fileContract", decodeString);
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getHasElectricity())) {
                        query.setParameter("hasElectricity", btsStationUpdate.getHasElectricity());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getRentalFee())) {
                        query.setParameter("rentalFee", btsStationUpdate.getRentalFee());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getAmount())) {
                        query.setParameter("amount", btsStationUpdate.getAmount());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getStatus())) {
                        query.setParameter("status", btsStationUpdate.getStatus());
                    }
                    if (Constant.BTS_ROLES.CMS_BTS_CND_STAFF.equals(roleCode)) {
                        if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getApprovedStatus())) {
                            query.setParameter("approvedStatus", btsStationUpdate.getApprovedStatus());
                        }
                        if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getNotes())) {
                            query.setParameter("notes", btsStationUpdate.getNotes());
                        }
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationUpdate.getId())) {
                        query.setParameter("btsStationId", btsStationUpdate.getId());
                    }
//                    System.out.println("Log querrrrrrrry---------------------------------" + sql.toString());
//                    System.out.println("Log parameter---------------------------------" + query.getParameter(9));
//                    System.out.println("Log parameter---------------------------------" + query.getParameter("startDatePayment").toString());

                    query.executeUpdate();
                    arr.add(btsStationUpdate.getSiteOnNims());
                    executionResult.setErrorCode(Constant.EXECUTION_ERROR.SUCCESS);

                } catch (Exception e) {
//            log.error(e.getMessage(), e);
                    executionResult.setErrorCode(Constant.EXECUTION_ERROR.ERROR);
                    executionResult.setDescription(e.getMessage());
                    e.printStackTrace();
                    throw e;
                }
            } else {
                executionResult.setErrorCode(Constant.EXECUTION_ERROR.ERROR);
                executionResult.setDescription("Lỗi hệ thống");
            }
            if (executionResult.getErrorCode().equals(Constant.EXECUTION_ERROR.SUCCESS)) {
                quantity += 1;
                btsStationDTOSendSMS.add(btsStationDTO);
                if (index == (btsStationDTOList.size() - 1)) {
                    listBTS = listBTS + btsStationDTO.getSiteOnNims();
                } else {
                    listBTS = listBTS + btsStationDTO.getSiteOnNims() + ", ";
                }
                index += 1;

                if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getProvinceCode())) {
                    if (!StringUtils.isStringNullOrEmpty(provinceCodeList)) {
                        for (String s : provinceCodeList) {
                            if (s.equals(btsStationDTO.getProvinceCode())) {
                                provinceCodeList.add(s);
                            }
                        }
                    }
                }
            }
        }
        String listStationSuccess = String.join(",", arr);
        executionResult.setDescription(r.getResourceMessage("update.station.success", listStationSuccess));
        listBTS = listBTS + ">";
        if (executionResult.getErrorCode().equals(Constant.EXECUTION_ERROR.SUCCESS) && Constant.BTS_ROLES.CMS_BTS_CN_STAFF.equals(roleCode)) {
            SmsDTO smsDTO = new SmsDTO();
            smsDTO.setProvinceCode(provinceCode);
            String message = String.format(templateCNUpdate.getValue(), quantity, listBTS);
            smsDTO.setMessage(message);
            smsDTO.setUserRole(Constant.CMS_ROLES.CMS_CORP_STAFF);
            SmsUtils.sendSMSForUserBTS(smsDTO, cms, env);
        } else if (executionResult.getErrorCode().equals(Constant.EXECUTION_ERROR.SUCCESS) && Constant.BTS_ROLES.CMS_BTS_CND_STAFF.equals(roleCode)) {
            String listBTSSendAprroved = "";
            String listBTSSendReject = "";
            int i = 0;
            int proIndexApproved = 0;
            int proIndeReject = 0;
            if (!StringUtils.isStringNullOrEmpty(provinceCodeList)) {
                listBTSSendAprroved = "";
                listBTSSendReject = "";
                for (String s : provinceCodeList) {
                    for (BTSStationDTO btsStationDTOSend : btsStationDTOSendSMS) {
                        listBTSSendAprroved = listBTSSendAprroved + "<";
                        listBTSSendReject = listBTSSendReject + "<";
                        if (!StringUtils.isStringNullOrEmpty(btsStationDTOSend.getProvinceCode())) {
                            if (1 == btsStationDTOSend.getApprovedStatus()) {
                                if (s.equals(btsStationDTOSend.getProvinceCode())) {
                                    if (i == (btsStationDTOList.size() - 1)) {
                                        listBTSSendAprroved = listBTSSendAprroved + btsStationDTOSend.getSiteOnNims();
                                    } else {
                                        listBTSSendAprroved = listBTSSendAprroved + btsStationDTOSend.getSiteOnNims() + ", ";
                                    }
                                    proIndexApproved++;
                                }
                            } else if (2 == btsStationDTOSend.getApprovedStatus()) {
                                if (s.equals(btsStationDTOSend.getProvinceCode())) {
                                    if (i == (btsStationDTOList.size() - 1)) {
                                        listBTSSendReject = listBTSSendReject + btsStationDTOSend.getSiteOnNims();
                                    } else {
                                        listBTSSendReject = listBTSSendReject + btsStationDTOSend.getSiteOnNims() + ", ";
                                    }
                                    proIndeReject++;
                                }
                                i++;
                            }
                        }
                        listBTSSendAprroved = listBTSSendAprroved + ">";
                        listBTSSendReject = listBTSSendReject + ">";
                        if (!StringUtils.isStringNullOrEmpty(listBTSSendAprroved) || !StringUtils.isStringNullOrEmpty(listBTSSendReject)) {
                            SmsDTO smsDTO = new SmsDTO();
                            smsDTO.setProvinceCode(s);
                            String message = String.format(templateCNDApproved.getValue(), proIndexApproved, listBTSSendAprroved, proIndeReject, listBTSSendReject);
                            smsDTO.setMessage(message);
                            smsDTO.setUserRole(Constant.CMS_ROLES.CMS_CORP_STAFF);
                            SmsUtils.sendSMSForUserBTS(smsDTO, cms, env);
                        }
                    }
                }
            }
        }
        return executionResult;
    }

    public BTSStation getBTSStationById(BTSStationDTO btsStationDTO, String roleCode) throws UnsupportedEncodingException, ParseException {
        try {
            Optional<BTSStation> result = btsStationRepo.findById(btsStationDTO.getId());
            BTSStation btsStation = result.orElse(null);
            if (!StringUtils.isStringNullOrEmpty(btsStation)) {
                if (Constant.BTS_ROLES.CMS_BTS_CN_STAFF.equals(roleCode)) {
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getLongitude()) && !(btsStation.getLongitude().equals(btsStationDTO.getLongitude()))) {
                        btsStation.setLongitude(btsStationDTO.getLongitude());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getLatitude()) && !(btsStation.getLatitude().equals(btsStationDTO.getLatitude()))) {
                        btsStation.setLatitude(btsStationDTO.getLatitude());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getContractNo()) && !(btsStation.getContractNo().equals(btsStationDTO.getContractNo()))) {
                        btsStation.setContractNo(btsStationDTO.getContractNo());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getName()) && !(btsStation.getName().equals(btsStationDTO.getName()))) {
                        btsStation.setName(btsStationDTO.getName());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getProvince()) && !(btsStation.getProvince().equals(btsStationDTO.getProvince()))) {
                        btsStation.setProvince(btsStationDTO.getProvince());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getDistrict()) && !(btsStation.getDistrict().equals(btsStationDTO.getDistrict()))) {
                        btsStation.setDistrict(btsStationDTO.getDistrict());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getAddress()) && !(btsStation.getAddress().equals(btsStationDTO.getAddress()))) {
                        btsStation.setAddress(btsStationDTO.getAddress());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getTelephone()) && !(btsStation.getTelephone().equals(btsStationDTO.getTelephone()))) {
                        btsStation.setTelephone(btsStationDTO.getTelephone());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDatePayment()) && !StringUtils.isStringNullOrEmpty(btsStation.getStartDatePayment())) {
                        if(!btsStation.getStartDatePayment().equals(btsStationDTO.getStartDatePayment())) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDatePayment()));
                            btsStation.setStartDatePayment(s);
                        }
                    } else if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDatePayment())){
                        String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDatePayment()));
                        btsStation.setStartDatePayment(s);
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDatePayment()) && !StringUtils.isStringNullOrEmpty(btsStation.getEndDatePayment())) {
                        if (!btsStation.getEndDatePayment().equals(btsStationDTO.getEndDatePayment())) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDatePayment()));
                            btsStation.setEndDatePayment(s);
                        }
                    }else if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDatePayment())){
                        String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDatePayment()));
                        btsStation.setEndDatePayment(s);
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getAmount()) && !(btsStation.getAmount() == btsStationDTO.getAmount())) {
                        btsStation.setAmount(btsStationDTO.getAmount());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getPaymentTime()) && !(btsStation.getPaymentTime() == btsStationDTO.getPaymentTime())) {
                        btsStation.setPaymentTime(btsStationDTO.getPaymentTime());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getFileContract()) && !(btsStation.getFileContract() == (btsStationDTO.getFileContract()))) {
//                        byte[] string = Base64.getEncoder().encode(btsStationDTO.getFileContract().getBytes());
//                        byte[] decodeString = Base64.getDecoder().decode(new String(string).getBytes("UTF-8"));
                        btsStation.setFileContract(btsStationDTO.getFileContract());
                    } else {
                        byte[] decodeString = new byte[]{};
                        btsStation.setFileContract(decodeString);
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getHasElectricity()) && !(btsStation.getHasElectricity() == btsStationDTO.getHasElectricity())) {
                        btsStation.setHasElectricity(btsStationDTO.getHasElectricity());
                    }

                } else if (Constant.BTS_ROLES.CMS_BTS_TCCN_STAFF.equals(roleCode)) {
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getLongitude()) && !(btsStation.getLongitude().equals(btsStationDTO.getLongitude()))) {
                        btsStation.setLongitude(btsStationDTO.getLongitude());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getLatitude()) && !(btsStation.getLatitude().equals(btsStationDTO.getLatitude()))) {
                        btsStation.setLatitude(btsStationDTO.getLatitude());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getContractNo()) && !(btsStation.getContractNo().equals(btsStationDTO.getContractNo()))) {
                        btsStation.setContractNo(btsStationDTO.getContractNo());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getName()) && !(btsStation.getName().equals(btsStationDTO.getName()))) {
                        btsStation.setName(btsStationDTO.getName());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getProvince()) && !(btsStation.getProvince().equals(btsStationDTO.getProvince()))) {
                        btsStation.setProvince(btsStationDTO.getProvince());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getDistrict()) && !(btsStation.getDistrict().equals(btsStationDTO.getDistrict()))) {
                        btsStation.setDistrict(btsStationDTO.getDistrict());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getAddress()) && !(btsStation.getAddress().equals(btsStationDTO.getAddress()))) {
                        btsStation.setAddress(btsStationDTO.getAddress());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getTelephone()) && !(btsStation.getTelephone().equals(btsStationDTO.getTelephone()))) {
                        btsStation.setTelephone(btsStationDTO.getTelephone());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDatePayment()) && !StringUtils.isStringNullOrEmpty(btsStation.getStartDatePayment())) {
                        if(!btsStation.getStartDatePayment().equals(btsStationDTO.getStartDatePayment())) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDatePayment()));
                            btsStation.setStartDatePayment(s);
                        }
                    } else if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDatePayment())){
                        String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDatePayment()));
                        btsStation.setStartDatePayment(s);
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDatePayment()) && !StringUtils.isStringNullOrEmpty(btsStation.getEndDatePayment())) {
                        if (!btsStation.getEndDatePayment().equals(btsStationDTO.getEndDatePayment())) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDatePayment()));
                            btsStation.setEndDatePayment(s);
                        }
                    }else if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDatePayment())){
                        String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDatePayment()));
                        btsStation.setEndDatePayment(s);
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getAmount()) && !StringUtils.isStringNullOrEmpty(btsStation.getAmount()) &&  !(btsStation.getAmount() == btsStationDTO.getAmount())) {
                        btsStation.setAmount(btsStationDTO.getAmount());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getPaymentTime()) && !(btsStation.getPaymentTime().equals(btsStationDTO.getPaymentTime()))) {
                        btsStation.setPaymentTime(btsStationDTO.getPaymentTime());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getPaymentTime()) && !StringUtils.isStringNullOrEmpty(btsStation.getPaymentTime()) &&  !(btsStation.getPaymentTime() == btsStationDTO.getPaymentTime())) {
                        btsStation.setPaymentTime(btsStationDTO.getPaymentTime());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getFileContract()) && !(btsStation.getFileContract() == btsStationDTO.getFileContract())) {
//                        byte[] string = Base64.getEncoder().encode(btsStationDTO.getFileContract().getBytes());
//                        byte[] decodeString = Base64.getDecoder().decode(new String(string).getBytes("UTF-8"));
                        btsStation.setFileContract(btsStationDTO.getFileContract());
                    } else {
                        byte[] decodeString = new byte[]{};
                        btsStation.setFileContract(decodeString);
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getHasElectricity()) && !(btsStation.getHasElectricity() == btsStationDTO.getHasElectricity())) {
                        btsStation.setHasElectricity(btsStationDTO.getHasElectricity());
                    }
                } else if (Constant.BTS_ROLES.CMS_BTS_CND_STAFF.equals(roleCode)) {
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getLongitude()) && !(btsStation.getLongitude().equals(btsStationDTO.getLongitude()))) {
//                        btsStation.setLongitude(btsStationDTO.getLongitude());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getLatitude()) && !(btsStation.getLatitude().equals(btsStationDTO.getLatitude()))) {
//                        btsStation.setLatitude(btsStationDTO.getLatitude());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getContractNo()) && !(btsStation.getContractNo().equals(btsStationDTO.getContractNo()))) {
//                        btsStation.setContractNo(btsStationDTO.getContractNo());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getName()) && !(btsStation.getName().equals(btsStationDTO.getName()))) {
//                        btsStation.setName(btsStationDTO.getName());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getProvince()) && !(btsStation.getProvince().equals(btsStationDTO.getProvince()))) {
//                        btsStation.setProvince(btsStationDTO.getProvince());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getDistrict()) && !(btsStation.getDistrict().equals(btsStationDTO.getDistrict()))) {
//                        btsStation.setDistrict(btsStationDTO.getDistrict());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getAddress()) && !(btsStation.getAddress().equals(btsStationDTO.getAddress()))) {
//                        btsStation.setAddress(btsStationDTO.getAddress());
//                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getPeriodOfRent()) && !(btsStation.getPreiodOfRent() == btsStationDTO.getPeriodOfRent())) {
                        btsStation.setPreiodOfRent(btsStationDTO.getPeriodOfRent());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDatePayment()) && !StringUtils.isStringNullOrEmpty(btsStation.getStartDatePayment())) {
                        if(!btsStation.getStartDatePayment().equals(btsStationDTO.getStartDatePayment())) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDatePayment()));
                            btsStation.setStartDatePayment(s);
                        }
                    } else if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDatePayment())){
                        String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDatePayment()));
                        btsStation.setStartDatePayment(s);
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDatePayment()) && !StringUtils.isStringNullOrEmpty(btsStation.getEndDatePayment())) {
                        if (!btsStation.getEndDatePayment().equals(btsStationDTO.getEndDatePayment())) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDatePayment()));
                            btsStation.setEndDatePayment(s);
                        }
                    }else if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDatePayment())){
                        String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDatePayment()));
                        btsStation.setEndDatePayment(s);
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getRentalFee()) && !(btsStation.getRentalFee() == btsStationDTO.getRentalFee())) {
                        btsStation.setRentalFee(btsStationDTO.getRentalFee());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getPaymentTime()) && !(btsStation.getPaymentTime() == btsStationDTO.getPaymentTime())) {
                        btsStation.setPaymentTime(btsStationDTO.getPaymentTime());
                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getFileContract()) && !(btsStation.getFileContract() == btsStationDTO.getFileContract())) {
////                        byte[] string = Base64.getEncoder().encode(btsStationDTO.getFileContract().getBytes());
////                        byte[] decodeString = Base64.getDecoder().decode(new String(string).getBytes("UTF-8"));
//                        btsStation.setFileContract(btsStationDTO.getFileContract());
//                    } else {
//                        byte[] decodeString = new byte[]{};
//                        btsStation.setFileContract(decodeString);
//                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getHasElectricity()) && !StringUtils.isStringNullOrEmpty(btsStation.getHasElectricity()) && !(btsStation.getHasElectricity() == btsStationDTO.getHasElectricity())) {
                        btsStation.setHasElectricity(btsStationDTO.getHasElectricity());
                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getPeriodOfRent()) && !StringUtils.isStringNullOrEmpty(btsStation.getPreiodOfRent()) && !(btsStation.getPreiodOfRent() == btsStationDTO.getPeriodOfRent())) {
//                        btsStation.setPreiodOfRent(btsStationDTO.getPeriodOfRent());
//                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStation.getStartDateContract())) {
                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDateContract()) && !(btsStation.getStartDateContract().equals(btsStationDTO.getStartDateContract()))) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDateContract()));
                            btsStation.setStartDateContract(s);
                        }
                    } else {
                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDateContract())) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDateContract()));
                            btsStation.setStartDateContract(s);
                        }
                    }
                        if (!StringUtils.isStringNullOrEmpty(btsStation.getEndDateContract())) {
                            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDateContract()) && !(btsStation.getEndDateContract().equals(btsStationDTO.getEndDateContract()))) {
                                String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDateContract()));
                                btsStation.setEndDateContract(s);
                            }
                        } else {
                            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDateContract())) {
                                String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDateContract()));
                                btsStation.setEndDateContract(s);
                            }
                        }
                    if (!StringUtils.isStringNullOrEmpty(btsStation.getSignDateContract())) {
                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getSignDateContract()) && !(btsStation.getSignDateContract().equals(btsStationDTO.getSignDateContract()))) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getSignDateContract()));
                            btsStation.setSignDateContract(s);
                        }
                    } else {
                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getSignDateContract())) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getSignDateContract()));
                            btsStation.setSignDateContract(s);
                        }
                    }


                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getApprovedStatus()) && !StringUtils.isStringNullOrEmpty(btsStation.getApprovedStatus()) && !(btsStation.getApprovedStatus() == btsStationDTO.getApprovedStatus())) {
                            btsStation.setApprovedStatus(btsStationDTO.getApprovedStatus());
                        }
                        if (!StringUtils.isStringNullOrEmpty(btsStation.getNotes())) {
                            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getNotes()) && !(btsStation.getNotes().equals(btsStationDTO.getNotes()))) {
                                btsStation.setNotes(btsStationDTO.getNotes());
                            }
                        } else {
                            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getNotes())) {
                                btsStation.setNotes(btsStationDTO.getNotes());
                            }
                        }
                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getApprovedStatus()) && (btsStationDTO.getApprovedStatus() == Long.valueOf(Constant.APPROVED_VALUE.APPROVE))) {
                            btsStation.setStatus(Long.valueOf(Constant.STATUS_VALUE.WORKING));
                        } else if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getApprovedStatus()) && (btsStationDTO.getApprovedStatus() == Long.valueOf(Constant.APPROVED_VALUE.REJECT))) {
                            btsStation.setStatus(Long.valueOf(Constant.STATUS_VALUE.TURN_OFF));
                        } else {
                            btsStation.setStatus(Long.valueOf(Constant.STATUS_VALUE.TURN_OFF));
                        }

                } else if (Constant.BTS_ROLES.CMS_BTS_GRAND_TC_STAFF.equals(roleCode)) {
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getLongitude()) && !(btsStation.getLongitude().equals(btsStationDTO.getLongitude()))) {
                        btsStation.setLongitude(btsStationDTO.getLongitude());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getLatitude()) && !(btsStation.getLatitude().equals(btsStationDTO.getLatitude()))) {
                        btsStation.setLatitude(btsStationDTO.getLatitude());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getContractNo()) && !(btsStation.getContractNo().equals(btsStationDTO.getContractNo()))) {
                        btsStation.setContractNo(btsStationDTO.getContractNo());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getName()) && !(btsStation.getName().equals(btsStationDTO.getName()))) {
                        btsStation.setName(btsStationDTO.getName());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getProvince()) && !(btsStation.getProvince().equals(btsStationDTO.getProvince()))) {
                        btsStation.setProvince(btsStationDTO.getProvince());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getDistrict()) && !(btsStation.getDistrict().equals(btsStationDTO.getDistrict()))) {
                        btsStation.setDistrict(btsStationDTO.getDistrict());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getAddress()) && !(btsStation.getAddress().equals(btsStationDTO.getAddress()))) {
                        btsStation.setAddress(btsStationDTO.getAddress());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getTelephone()) && !(btsStation.getTelephone().equals(btsStationDTO.getTelephone()))) {
                        btsStation.setTelephone(btsStationDTO.getTelephone());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDatePayment()) && !StringUtils.isStringNullOrEmpty(btsStation.getStartDatePayment())) {
                        if(!btsStation.getStartDatePayment().equals(btsStationDTO.getStartDatePayment())) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDatePayment()));
                            btsStation.setStartDatePayment(s);
                        }
                    } else if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDatePayment())){
                        String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDatePayment()));
                        btsStation.setStartDatePayment(s);
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDatePayment()) && !StringUtils.isStringNullOrEmpty(btsStation.getEndDatePayment())) {
                        if (!btsStation.getEndDatePayment().equals(btsStationDTO.getEndDatePayment())) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDatePayment()));
                            btsStation.setEndDatePayment(s);
                        }
                    }else if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDatePayment())){
                        String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDatePayment()));
                        btsStation.setEndDatePayment(s);
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getAmount()) && !(btsStation.getAmount() == btsStationDTO.getAmount())) {
                        btsStation.setAmount(btsStationDTO.getAmount());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getPaymentTime()) && !(btsStation.getPaymentTime() == btsStationDTO.getPaymentTime())) {
                        btsStation.setPaymentTime(btsStationDTO.getPaymentTime());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getFileContract()) && !(btsStation.getFileContract() == btsStationDTO.getFileContract())) {
//                        byte[] string = Base64.getEncoder().encode(btsStationDTO.getFileContract().getBytes());
//                        byte[] decodeString = Base64.getDecoder().decode(new String(string).getBytes("UTF-8"));
                        btsStation.setFileContract(btsStationDTO.getFileContract());
                    } else {
                        byte[] decodeString = new byte[]{};
                        btsStation.setFileContract(decodeString);
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getHasElectricity()) && !(btsStation.getHasElectricity() == btsStationDTO.getHasElectricity())) {
                        btsStation.setHasElectricity(btsStationDTO.getHasElectricity());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getPeriodOfRent()) && !(btsStation.getPreiodOfRent() == btsStationDTO.getPeriodOfRent())) {
                        btsStation.setPreiodOfRent(btsStationDTO.getPeriodOfRent());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStation.getStartDateContract())) {
                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDateContract()) && !(btsStation.getStartDateContract().equals(btsStationDTO.getStartDateContract()))) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDateContract()));
                            btsStation.setStartDateContract(s);
                        }
                    } else {
                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDateContract())) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDateContract()));
                            btsStation.setStartDateContract(s);
                        }
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStation.getEndDateContract())) {
                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDateContract()) && !(btsStation.getEndDateContract().equals(btsStationDTO.getEndDateContract()))) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDateContract()));
                            btsStation.setEndDateContract(s);
                        }
                    } else {
                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDateContract())) {
                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDateContract()));
                            btsStation.setEndDateContract(s);
                        }
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getRentalFee()) && !(btsStation.getRentalFee() == btsStationDTO.getRentalFee())) {
                        btsStation.setRentalFee(btsStationDTO.getRentalFee());
                    }
                } else if (Constant.BTS_ROLES.CMS_BTS_PNO_STAFF.equals(roleCode)) {
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getLongitude()) && !(btsStation.getLongitude().equals(btsStationDTO.getLongitude()))) {
                        btsStation.setLongitude(btsStationDTO.getLongitude());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getLatitude()) && !(btsStation.getLatitude().equals(btsStationDTO.getLatitude()))) {
                        btsStation.setLatitude(btsStationDTO.getLatitude());
                    }
                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getContractNo()) && !(btsStation.getContractNo().equals(btsStationDTO.getContractNo()))) {
                        btsStation.setContractNo(btsStationDTO.getContractNo());
                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getName()) && !(btsStation.getName().equals(btsStationDTO.getName()))) {
//                        btsStation.setName(btsStationDTO.getName());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getProvince()) && !(btsStation.getProvince().equals(btsStationDTO.getProvince()))) {
//                        btsStation.setProvince(btsStationDTO.getProvince());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getDistrict()) && !(btsStation.getDistrict().equals(btsStationDTO.getDistrict()))) {
//                        btsStation.setDistrict(btsStationDTO.getDistrict());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getAddress()) && !(btsStation.getAddress().equals(btsStationDTO.getAddress()))) {
//                        btsStation.setAddress(btsStationDTO.getAddress());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getTelephone()) && !(btsStation.getTelephone().equals(btsStationDTO.getTelephone()))) {
//                        btsStation.setTelephone(btsStationDTO.getTelephone());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDatePayment()) && !StringUtils.isStringNullOrEmpty(btsStation.getStartDatePayment())) {
//                        if(!btsStation.getStartDatePayment().equals(btsStationDTO.getStartDatePayment())) {
//                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDatePayment()));
//                            btsStation.setStartDatePayment(s);
//                        }
//                    } else if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDatePayment())){
//                        String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDatePayment()));
//                        btsStation.setStartDatePayment(s);
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDatePayment()) && !StringUtils.isStringNullOrEmpty(btsStation.getEndDatePayment())) {
//                        if (!btsStation.getEndDatePayment().equals(btsStationDTO.getEndDatePayment())) {
//                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDatePayment()));
//                            btsStation.setEndDatePayment(s);
//                        }
//                    }else if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDatePayment())){
//                        String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDatePayment()));
//                        btsStation.setEndDatePayment(s);
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getAmount()) && !(btsStation.getAmount() == btsStationDTO.getAmount())) {
//                        btsStation.setAmount(btsStationDTO.getAmount());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getPaymentTime()) && !(btsStation.getPaymentTime() == btsStationDTO.getPaymentTime())) {
//                        btsStation.setPaymentTime(btsStationDTO.getPaymentTime());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getFileContract()) && !(btsStation.getFileContract() == btsStationDTO.getFileContract())) {
////                        byte[] string = Base64.getEncoder().encode(btsStationDTO.getFileContract().getBytes());
////                        byte[] decodeString = Base64.getDecoder().decode(new String(string).getBytes("UTF-8"));
//                        btsStation.setFileContract(btsStationDTO.getFileContract());
//                    } else {
//                        byte[] decodeString = new byte[]{};
//                        btsStation.setFileContract(decodeString);
//                    }
//
//                    if (StringUtils.isStringNullOrEmpty(btsStation.getFileCR())) {
//                        byte[] decodeString = new byte[]{};
//                        btsStation.setFileContract(decodeString);
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getHasElectricity()) && !(btsStation.getHasElectricity().equals(btsStationDTO.getHasElectricity()))) {
//                        btsStation.setHasElectricity(btsStationDTO.getHasElectricity());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getPeriodOfRent()) && !(btsStation.getPreiodOfRent() == btsStationDTO.getPeriodOfRent())) {
//                        btsStation.setPreiodOfRent(btsStationDTO.getPeriodOfRent());
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStation.getStartDateContract())) {
//                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDateContract()) && !(btsStation.getStartDateContract().equals(btsStationDTO.getStartDateContract()))) {
//                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDateContract()));
//                            btsStation.setStartDateContract(s);
//                        }
//                    } else {
//                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getStartDateContract())) {
//                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getStartDateContract()));
//                            btsStation.setStartDateContract(s);
//                        }
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStation.getEndDateContract())) {
//                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDateContract()) && !(btsStation.getEndDateContract().equals(btsStationDTO.getEndDateContract()))) {
//                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDateContract()));
//                            btsStation.setEndDateContract(s);
//                        }
//                    } else {
//                        if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getEndDateContract())) {
//                            String s = formatterString.format(formatterDate.parse(btsStationDTO.getEndDateContract()));
//                            btsStation.setEndDateContract(s);
//                        }
//                    }
//                    if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getRentalFee()) && !(btsStation.getRentalFee() == btsStationDTO.getRentalFee())) {
//                        btsStation.setRentalFee(btsStationDTO.getRentalFee());
//                    }
                }
                return btsStation;
            } else {
                return null;
            }

        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void approvedBTSStation(BTSStationDTO btsStationDTO) throws Exception {
        try {
            int updateApprovedStatusConstruction = updateBTSStationStatus(btsStationDTO);
            if (updateApprovedStatusConstruction != 1) {
                throw new Exception();
            }
            /*
            ghi log
             */

        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void turnOffBTSStation(BTSStationDTO btsStationDTO) throws Exception {
        try {

            int turnOffBTSStation = updateStatusBTSStation(btsStationDTO);
            if (turnOffBTSStation != 1) {
                throw new Exception();
            }

            /*
            ghi log
             */
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    @Override
    public ExecutionResult getBTSStationFromFile(MultipartFile fileCreateRequest, String userName, String locate) throws Exception {
        try {
            OutputCreateConstructionDTO outputCreateConstructionDTO = new OutputCreateConstructionDTO();
            com.viettel.vfw5.base.utils.ResourceBundle r = new ResourceBundle(locate);
            ExecutionResult res = new ExecutionResult();
            res.setErrorCode(Constant.EXECUTION_ERROR.SUCCESS);
            List<BTSStationDTO> btsStationDTOList = new ArrayList<>();
            XSSFWorkbook workbook = new XSSFWorkbook(fileCreateRequest.getInputStream());
            XSSFSheet worksheet = workbook.getSheetAt(0);
            int lenFile = worksheet.getLastRowNum();
            if (lenFile < 1) {
                res.setErrorCode(Constant.EXECUTION_ERROR.ERROR);
                res.setDescription(r.getResourceMessage("construction.info.file.null"));
                return res;
            }
            Cell columnHead = worksheet.getRow(0).getCell(5);
            if (StringUtils.isStringNullOrEmpty(columnHead)) {
                columnHead = worksheet.getRow(0).createCell(5);
            }
            columnHead.setCellValue("Lỗi");
            for (int i = 1; i <= lenFile; i++) {
                XSSFRow row = worksheet.getRow(i);
                if (ObjectUtils.isEmpty(row)) {
                    break;
                }
                BTSStationDTO btsStationDTO = new BTSStationDTO();
                for (int j = 1; j < row.getLastCellNum(); j++) {
                    switch (row.getCell(j).getCellTypeEnum()) {
                        case STRING:
                            if (j == 1) {
                                if (!StringUtils.isStringNullOrEmpty(row.getCell(j).getStringCellValue().toUpperCase())) {
                                    btsStationDTO.setSiteOnNims(row.getCell(j).getStringCellValue().toUpperCase());
                                }
                            }
                            if (j == 2) {
                                if (!StringUtils.isStringNullOrEmpty(row.getCell(j).getStringCellValue().toUpperCase())) {
                                    btsStationDTO.setSiteOnContract(row.getCell(j).getStringCellValue());
                                }
                                btsStationDTO.setContractNo(row.getCell(j).getStringCellValue());
                            }
                            break;
                        case NUMERIC:
                            if (j == 3) {
                                if (!StringUtils.isStringNullOrEmpty(row.getCell(j).getNumericCellValue())) {
                                    btsStationDTO.setLongitude(String.valueOf(row.getCell(j).getNumericCellValue()));
                                }
                            }
                            if (j == 4) {
                                if (!StringUtils.isStringNullOrEmpty(row.getCell(j).getNumericCellValue())) {
                                    btsStationDTO.setLatitude(String.valueOf(row.getCell(j).getNumericCellValue()));
                                }
                            }
                            break;
                        default:
                            break;
                    }
                }
                /*
                validate dữ liệu 1 bản ghi construction
                 */
                ExecutionResult tempRes = FunctionUtils.validateNullInputBTSStation(btsStationDTO, locate, btsStationService);
                Cell lastCell = row.getCell(5);
                if (StringUtils.isStringNullOrEmpty(lastCell)) {
                    lastCell = row.createCell(5);
                }
                if (!Constant.EXECUTION_ERROR.ERROR.equals(tempRes.getErrorCode())) {
                    tempRes = FunctionUtils.validateInputBTSStation(btsStationDTO,
                            locate,
                            btsStationService,
                            locationService,
                            optionSetValueService);
                    if (!Constant.EXECUTION_ERROR.ERROR.equals(tempRes.getErrorCode())) {
                        btsStationDTOList.add(btsStationDTO);
                        /*
                    lưu dữ liệu 1 bản ghi construction
                         */
                        btsStationDTO.setCreatedUser(userName.split("----")[0]);
                        btsStationDTO.setCreatedDate(String.valueOf(LocalDateTime.now()));
                        btsStationDTO.setApprovedStatus(1L);
                        createBTSStation(btsStationDTO);
                        lastCell.setCellValue("");

                    } else {
                        //ghi loi
                        lastCell.setCellValue(tempRes.getDescription());
                    }
                } else {
                    //ghi loi
                    lastCell.setCellValue(tempRes.getDescription());
                }
            }
            //convert to base64
            ByteArrayOutputStream bos = new ByteArrayOutputStream();
            workbook.write(bos);
            byte[] bytes = bos.toByteArray();
//            byte[] bytes = IOUtils.toByteArray(fileCreateRequest.getInputStream());
            String base64 = "";
            base64 = Base64.getEncoder().encodeToString(bytes);

            if (!StringUtils.isStringNullOrEmpty(fileCreateRequest.getOriginalFilename())) {
                outputCreateConstructionDTO.setName(fileCreateRequest.getOriginalFilename());
            }
            if (!StringUtils.isStringNullOrEmpty(base64)) {
                outputCreateConstructionDTO.setFileContent(base64);
            }

            res.setDescription(r.getResourceMessage("construction.number.gen.success", new Object[]{btsStationDTOList.size(), lenFile}));
            if (btsStationDTOList.size() != lenFile) {
                res.setData(outputCreateConstructionDTO);
            }
            return res;
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    @Override
    public List<BTSStation> getListBTSStation(BTSStationDTO btsStationDTO) throws Exception {
        try {
//            List<Construction> listConstructionDTO = new ArrayList<>();
            String sql = "SELECT  "
                    + "  *   "
                    + "FROM  "
                    + "  bts_rent_place   "
                    + "WHERE  "
                    + "  STATUS in (0,1,2,3,4) ";
            if (!DataUtil.isNullOrEmpty(btsStationDTO.getSiteOnNims())) {
                sql += "AND site_on_nims = :siteOnNims ";
            }
//            if (!DataUtil.isNullOrEmpty(btsStationDTO.getSiteOnContract())) {
//                sql += "AND site_on_contract = :siteOnContract ";
//            }
            Query query = cms.createNativeQuery(sql, BTSStation.class);

            if (!DataUtil.isNullOrEmpty(btsStationDTO.getSiteOnNims())) {
                query.setParameter("siteOnNims", btsStationDTO.getSiteOnNims().trim());
            }
//            if (!DataUtil.isNullOrEmpty(btsStationDTO.getSiteOnContract())) {
//                query.setParameter("siteOnContract", btsStationDTO.getSiteOnContract().trim());
//            }
            List<BTSStation> lst = query.getResultList();
            return lst;
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    @Override
    public List<BTSStation> getListBTSStationById(BTSStationDTO btsStationDTO) throws Exception {
        try {
//            List<Construction> listConstructionDTO = new ArrayList<>();
            String sql = "SELECT  "
                    + "  *   "
                    + "FROM  "
                    + "  bts_rent_place brp  "
                    + " WHERE   brp.id = :id ";
            Query query = cms.createNativeQuery(sql, BTSStation.class);

            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getId())) {
                query.setParameter("id", btsStationDTO.getId());
            }
            List<BTSStation> lst = query.getResultList();
            return lst;
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    @Override
    public String getStatusBTSStation(BTSStationDTO btsStationDTO) throws Exception {
        String result = "";
        try {
            StringBuilder sql = new StringBuilder();
            sql.append(" SELECT   brp.status "
                    + "  FROM   bts_rent_place brp "
                    + " WHERE   brp.id = :id ");
            Query query = cms.createNativeQuery(sql.toString());
            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getId())) {
                query.setParameter("id", btsStationDTO.getId());
            }
            List<Integer> lst = query.getResultList();
            if (!lst.isEmpty() && lst != null) {
                for (Integer obj : lst) {
                    int i = 0;
                    if (!StringUtils.isStringNullOrEmpty(obj)) {
                        result = String.valueOf(DataUtils.getString(obj));
                    } else {
                        result = "";
                    }

                }
            }
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
        return result;
    }

    @Override
    public String getApprovedStatusBTSStation(BTSStationDTO btsStationDTO) throws Exception {
        String result = "";
        try {
            StringBuilder sql = new StringBuilder();
            sql.append(" SELECT   brp.approved_status "
                    + "  FROM   bts_rent_place brp "
                    + " WHERE   brp.id = :id ");
            Query query = cms.createNativeQuery(sql.toString());
            if (!StringUtils.isStringNullOrEmpty(btsStationDTO.getId())) {
                query.setParameter("id", btsStationDTO.getId());
            }
            List<Integer> lst = query.getResultList();
            if (!lst.isEmpty() && lst != null) {
                for (Integer obj : lst) {
                    int i = 0;
                    if (!StringUtils.isStringNullOrEmpty(obj)) {
                        result = String.valueOf(DataUtils.getString(obj));
                    } else {
                        result = "";
                    }

                }
            }
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
        return result;
    }

    @Override
    public String getProvinceCodeOfStaff(String staffName) throws Exception {
        String result = "";
        try {
            StringBuilder sql = new StringBuilder();
            sql.append(" SELECT   s.province_code "
                    + "  FROM   staff s "
                    + " WHERE   s.staff_name = :staffName ");
            Query query = cms.createNativeQuery(sql.toString());
            if (!StringUtils.isStringNullOrEmpty(staffName)) {
                query.setParameter("staffName", staffName);
            }
            List<String> lst = query.getResultList();
            if (!lst.isEmpty() && lst != null) {
                for (String obj : lst) {
                    int i = 0;
                    result = obj;
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
        return result;
    }

    @Override
    public Long getProvinceIdByCode(String provinceCode) throws Exception {
        Long provinceId = null;
        try {
//            List<Construction> listConstructionDTO = new ArrayList<>();
            String sql = "SELECT  "
                    + "  p.pro_id   "
                    + "FROM  "
                    + "  province p  "
                    + " WHERE   p.pro_code = :provinceCode ";
            Query query = cms.createNativeQuery(sql);

            if (!StringUtils.isStringNullOrEmpty(provinceCode)) {
                query.setParameter("provinceCode", provinceCode);
            }
            List<Object> lst = query.getResultList();
            if (!DataUtil.isNullOrEmpty(lst)) {
                provinceId = DataUtils.getLong(lst.get(0));
            }
            return provinceId;
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    @Override
    public List<String> getListIsdnByDeptCode(String deptCode) throws Exception {
        try {
//            List<Construction> listConstructionDTO = new ArrayList<>();
            String sql = "SELECT  "
                    + "  ss.staff_mobile  "
                    + "FROM  "
                    + "  sms_staff ss  "
                    + " WHERE   ss.pro_code = :deptCode ";
            Query query = cms.createNativeQuery(sql, BTSStation.class);

            if (!StringUtils.isStringNullOrEmpty(deptCode)) {
                query.setParameter("deptCode", deptCode);
            }
            List<String> lst = query.getResultList();
            return lst;
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    private Long getConstructionTypeByName(String constructionTypeName) {
        try {
            String sql = " select * from construction_type where status = 1 and construction_type_name = :constructionTypeName ";
            Query query = cms.createNativeQuery(sql, ConstructionType.class);
            query.setParameter("constructionTypeName", constructionTypeName);
            List<ConstructionType> constructionTypeList = query.getResultList();
            return constructionTypeList.get(0).getConstructionTypeId();
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    public int updateBTSStationStatus(BTSStationDTO btsStationDTO) throws Exception {
        try {
            StringBuilder sql = new StringBuilder();
            sql.append("UPDATE   bts_rent_place brp"
                    + "   SET   brp.approved_status = :approvedStatus , brp.notes = :notes , last_modified_date = :updateDate , last_modified_user = :updateBy "
                    + " WHERE   brp.id = :btsStationId ");
            Query query = cms.createNativeQuery(sql.toString());
            query.setParameter("updateDate", btsStationDTO.getLastModifiedDate());
            query.setParameter("updateBy", btsStationDTO.getLastModifiedUser());
            query.setParameter("btsStationId", btsStationDTO.getId());
            query.setParameter("approvedStatus", btsStationDTO.getApprovedStatus());
            query.setParameter("notes", btsStationDTO.getNotes());
            return query.executeUpdate();
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

    public int updateStatusBTSStation(BTSStationDTO btsStationDTO) throws Exception {
        try {
            byte[] string = Base64.getEncoder().encode(btsStationDTO.getFileCRBase64().getBytes());
            byte[] decodeString = Base64.getDecoder().decode(new String(string).getBytes("UTF-8"));
            StringBuilder sql = new StringBuilder();
            LocalDateTime now = LocalDateTime.now();
            sql.append("UPDATE   bts_rent_place brp"
                    + "   SET   brp.status = :status , "
                    + " brp.file_CR = :fileCR , last_modified_date = :updateDate , "
                    + " last_modified_user = :updateBy, "
                    + " turn_off_date = :turnOffDate"
                    + " WHERE   brp.id = :btsStationId and status = 1 and approved_status = 1 ");
            Query query = cms.createNativeQuery(sql.toString());
            query.setParameter("updateDate", now);
            query.setParameter("updateBy", btsStationDTO.getLastModifiedUser());
            query.setParameter("btsStationId", btsStationDTO.getId());
            query.setParameter("status", btsStationDTO.getStatus());
            query.setParameter("turnOffDate", now);
//            query.setParameter("fileCR", btsStationDTO.getFileCRBase64());
            query.setParameter("fileCR", decodeString);

            return query.executeUpdate();
        } catch (Exception e) {
            e.printStackTrace();
            throw e;
        }
    }

}
